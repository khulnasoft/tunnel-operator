# Vulnerability Scanning Configuration

## Standalone

The default configuration settings enable Tunnel `vulnerabilityReports.scanner` in [`Standalone`][tunnel-standalone]
`tunnel.mode`. Even though it doesn't require any additional setup, it's the least efficient method. Each Pod created
by a scan Job has the init container that downloads the Tunnel vulnerabilities database from the GitHub releases page
and stores it in the local file system of the [emptyDir volume]. This volume is then shared with containers that perform
the actual scanning. Finally, the Pod is deleted along with the emptyDir volume.

![](./../../images/design/tunnel-standalone.png)

The number of containers defined by a scan Job equals the number of containers defined by the scanned Kubernetes
workload, so the cache in this mode is useful only if the workload defines multiple containers.

Beyond that, frequent downloads from GitHub might lead to a [rate limiting] problem. The limits are imposed by GitHub on
all anonymous requests originating from a given IP. To mitigate such problems you can add the `tunnel.githubToken` key to
the `tunnel-operator` secret.

```bash

kubectl patch secret tunnel-operator-tunnel-config -n tunnel-system \
  --type merge \
  -p "$(cat <<EOF
{
  "data": {
    "tunnel.githubToken": "$(echo -n <GITHUB_TOKEN> | base64)"
  }
}
EOF
)"
```

## ClientServer

You can connect Tunnel to an external Tunnel server by changing the default `tunnel.mode` from
[`Standalone`][tunnel-standalone] to [`ClientServer`][tunnel-clientserver] and specifying `tunnel.serverURL`.

```bash
kubectl patch cm tunnel-operator-tunnel-config -n tunnel-system \
  --type merge \
  -p "$(cat <<EOF
{
  "data": {
    "tunnel.mode":      "ClientServer",
    "tunnel.serverURL": "<TUNNEL_SERVER_URL>"
  }
}
EOF
)"
```

The Tunnel server could be your own deployment, or it could be an external service. See [Tunnel server][tunnel-clientserver] documentation for more information.

If the server requires access token and/or custom HTTP authentication headers, you may add `tunnel.serverToken` and `tunnel.serverCustomHeaders` properties to the Tunnel Operator secret.

```bash
kubectl patch secret tunnel-operator-tunnel-config -n tunnel-system \
  --type merge \
  -p "$(cat <<EOF
{
  "data": {
    "tunnel.serverToken":         "$(echo -n <SERVER_TOKEN> | base64)",
    "tunnel.serverCustomHeaders": "$(echo -n x-api-token:<X_API_TOKEN> | base64)"
  }
}
EOF
)"
```

![](./../../images/design/tunnel-clientserver.png)

## Settings

| CONFIGMAP KEY                            | DEFAULT                                   | DESCRIPTION                                                                                                                                                                                                                                                                                                                                                                                      |
|------------------------------------------|-------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `tunnel.repository`                       | `ghcr.io/aquasecurity/trivy`              | Repository of the Tunnel image                                                                                                                                                                                                                                                                                                                                                                    |
| `tunnel.tag`                              | `0.36.0`                                  | Version of the Tunnel image                                                                                                                                                                                                                                                                                                                                                                       |
| `tunnel.imagePullSecret`                  | N/A                                       | imagePullSecret is the secret name to be used when pulling tunnel image from private registries example: `reg-secret`. It is the user responsibility to create the secret for the private registry in `tunnel-operator` namespace.                                                                                                                                                                 |
| `tunnel.dbRepository`                     | `ghcr.io/khulnasoft-lab/tunnel-db`           | External OCI Registry to download the vulnerability database                                                                                                                                                                                                                                                                                                                                     |
| `tunnel.javaDbRepository`                 | `ghcr.io/aquasecurity/trivy-java-db`      | External OCI Registry to download the vulnerability database for Java                                                                                                                                                                                                                                                                                                                            |
| `tunnel.dbRepositoryInsecure`             | `false`                                   | The Flag to enable insecure connection for downloading tunnel-db via proxy (air-gaped env)                                                                                                                                                                                                                                                                                                        |
| `tunnel.mode`                             | `Standalone`                              | Tunnel client mode. Either `Standalone` or `ClientServer`. Depending on the active mode other settings might be applicable or required.                                                                                                                                                                                                                                                           |
| `additionalVulnerabilityReportFields`    | N/A                                       | A comma separated list of additional fields which can be added to the VulnerabilityReport. Possible values: `Description,Links,CVSS,Target,Class,PackagePath,PackageType`. Description will add more data about vulnerability. Links - all the references to a specific vulnerability. CVSS - data about CVSSv2/CVSSv3 scoring and vectors. Target - vulnerable element. Class - OS or library vulnerability |
| `tunnel.command`                          | `image`                                   | command. One of `image`, `filesystem` or `rootfs` scanning. Depending on the target type required for the scan.                                                                                                                                                                                                                                                                                  |
| `tunnel.slow`                             | `true`                                    | this flag is to use less CPU/memory for scanning though it takes more time than normal scanning. It fits small-footprint                                                                                                                                                                                                                                                                         |
| `tunnel.severity`                         | `UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL`        | A comma separated list of severity levels reported by Tunnel                                                                                                             |
| `tunnel.ignoreUnfixed`                    | N/A                                       | Whether to show only fixed vulnerabilities in vulnerabilities reported by Tunnel. Set to `"true"` to enable it.                                                                                                                                                                                                                                                                                   |
| `tunnel.vulnType`                    | ``                                      | this flag can be used to tell Tunnel to filter vulnerabilities by a pkg-type (library, os)                                                                                                                                                                                                                                                                                   |
| `tunnel.offlineScan`                      | N/A                                       | Whether to enable the offline scan mode of Tunnel preventing outgoing calls, e.g. to <search.maven.org> for additional vulnerability information. Set to `"true"` to enable it.                                                                                                                                                                                                                   |
| `tunnel.skipFiles`                        | N/A                                       | A comma separated list of file paths for Tunnel to skip traversal.                                                                                                                                                                                                                                                                                                                                |
| `tunnel.skipDirs`                         | N/A                                       | A comma separated list of directories for Tunnel to skip traversal.                                                                                                                                                                                                                                                                                                                               |
| `tunnel.ignoreFile`                       | N/A                                       | It specifies the `.tunnelignore` file which contains a list of vulnerability IDs to be ignored from vulnerabilities reported by Tunnel.                                                                                                                                                                                                                                                            |
| `tunnel.ignorePolicy`                     | N/A                                       | It specifies a fallback [policy](https://khulnasoft.github.io/tunnel/latest/docs/vulnerability/examples/filter/#by-open-policy-agent) file which allows to customize which vulnerabilities are reported by Tunnel.                                                                                                                                                                               |
| `tunnel.ignorePolicy.{ns}`                | N/A                                       | It specifies a namespace specific [policy](https://khulnasoft.github.io/tunnel/latest/docs/vulnerability/examples/filter/#by-open-policy-agent) file which allows to customize which vulnerabilities are reported by Tunnel.                                                                                                                                                                     |
| `tunnel.ignorePolicy.{ns}.{wl}`           | N/A                                       | It specifies a namespace/workload specific [policy](https://khulnasoft.github.io/tunnel/latest/docs/vulnerability/examples/filter/#by-open-policy-agent) file which allows to customize which vulnerabilities are reported by Tunnel.                                                                                                                                                            |
| `tunnel.timeout`                          | `5m0s`                                    | The duration to wait for scan completion                                                                                                                                                                                                                                                                                                                                                         |
| `tunnel.serverURL`                        | N/A                                       | The endpoint URL of the Tunnel server. Required in `ClientServer` mode.                                                                                                                                                                                                                                                                                                                           |
| `node.collector.imageRef`                | ghcr.io/khulnasoft/node-collector:0.0.6 | The imageRef use for node-collector job .                                                                                                                                                                                                                                                                                                                                                        |
| `node.collector.imagePullSecret`             | N/A                | imagePullSecret is the secret name to be used when pulling tunnel node-collector from private registries .                                                                                                                                                                                                                                                                                                           |
| `tunnel.serverTokenHeader`                | `Tunnel-Token`                             | The name of the HTTP header to send the authentication token to Tunnel server. Only application in `ClientServer` mode when `tunnel.serverToken` is specified.                                                                                                                                                                                                                                     |
| `tunnel.serverInsecure`                   | N/A                                       | The Flag to enable insecure connection to the Tunnel server.                                                                                                                                                                                                                                                                                                                                      |
| `tunnel.insecureRegistry.<id>`            | N/A                                       | The registry to which insecure connections are allowed. There can be multiple registries with different registry `<id>`.                                                                                                                                                                                                                                                                         |
| `tunnel.nonSslRegistry.<id>`              | N/A                                       | A registry without SSL. There can be multiple registries with different registry `<id>`.                                                                                                                                                                                                                                                                                                         |
| `tunnel.sslCertDir`                         | N/A                                  | sslCertDir can be used to override the system default locations for SSL certificate files directory , example: /ssl/certs                                                                                                                                                                               |
| `tunnel.registry.mirror.<registry>`       | N/A                                       | Mirror for the registry `<registry>`, e.g. `tunnel.registry.mirror.index.docker.io: mirror.io` would use `mirror.io` to get images originated from `index.docker.io`                                                                                                                                                                                                                              |
| `tunnel.httpProxy`                        | N/A                                       | The HTTP proxy used by Tunnel to download the vulnerabilities database from GitHub.                                                                                                                                                                                                                                                                                                               |
| `tunnel.httpsProxy`                       | N/A                                       | The HTTPS proxy used by Tunnel to download the vulnerabilities database from GitHub.                                                                                                                                                                                                                                                                                                              |
| `tunnel.noProxy`                          | N/A                                       | A comma separated list of IPs and domain names that are not subject to proxy settings.                                                                                                                                                                                                                                                                                                           |
| `tunnel.resources.requests.cpu`           | `100m`                                    | The minimum amount of CPU required to run Tunnel scanner pod.                                                                                                                                                                                                                                                                                                                                     |
| `tunnel.resources.requests.memory`        | `100M`                                    | The minimum amount of memory required to run Tunnel scanner pod.                                                                                                                                                                                                                                                                                                                                  |
| `tunnel.resources.requests.ephemeral-storage`        |``                                    | The minimum amount of ephemeral-storage required to run Tunnel scanner pod.                                                                                                                                                                                                                                                                                                                |
| `tunnel.resources.limits.cpu`             | `500m`                                    | The maximum amount of CPU allowed to run Tunnel scanner pod.                                                                                                                                                                                                                                                                                                                                      |
| `tunnel.resources.limits.memory`          | `500M`                                    | The maximum amount of memory allowed to run Tunnel scanner pod.                                                                                                                                                                                                                                                                                                                                   |
| `tunnel.resources.limits.ephemeral-storage`          | ``| The maximum amount of ephemeral-storage allowed to run Tunnel scanner pod.                                                                                                                                                                                                                                                                                                                 |
| `tunnel.storageClassName`                 | ``                                        | The name of the storage class to be used for Tunnel server PVC.                                                                                                                                                                                                                                                                                                                                   |
| `tunnel.podLabels`                        | ``| The extra pod labels to be used for Tunnel server.                                                                                                                                                                                                                                                                                                                                                |
| `tunnel.priorityClassName`                | ``                                        | PriorityClassName is the name of the priority class used for tunnel server.                                                                                                                                                                                                                                                                                                                       |
| `tunnel.server.resources.requests.cpu`    | `200m`                                    | The minimum amount of CPU required to run tunnel server.                                                                                                                                                                                                                                                                                                                                          |
| `tunnel.server.resources.requests.memory` | `512Mi`                                   | The minimum amount of memory required to run tunnel server.                                                                                                                                                                                                                                                                                                                                       |
| `tunnel.server.resources.limits.cpu`      | `1`                                       | The maximum amount of CPU allowed to run tunnel server.                                                                                                                                                                                                                                                                                                                                           |
| `tunnel.server.resources.limits.memory`   | `1Gi`                                     | The maximum amount of memory allowed to run tunnel server.                                                                                                                                                                                                                                                                                                                                        |

| SECRET KEY| DESCRIPTION|
|---|---|
| `tunnel.githubToken`| The GitHub access token used by Tunnel to download the vulnerabilities database from GitHub. Only applicable in `Standalone` mode. |
| `tunnel.serverToken`| The token to authenticate Tunnel client with Tunnel server. Only applicable in `ClientServer` mode.|
| `tunnel.serverCustomHeaders`| A comma separated list of custom HTTP headers sent by Tunnel client to Tunnel server. Only applicable in `ClientServer` mode.|

[tunnel-standalone]: https://khulnasoft.github.io/tunnel/latest/docs/references/modes/standalone/
[emptyDir volume]: https://kubernetes.io/docs/concepts/storage/volumes/#emptydir
[rate limiting]: https://docs.github.com/en/free-pro-team@latest/rest/overview/resources-in-the-rest-api#rate-limiting
[tunnel-clientserver]: https://khulnasoft.github.io/tunnel/latest/docs/references/modes/client-server/
